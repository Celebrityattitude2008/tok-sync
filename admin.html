<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TokSync - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tok-gradient { background: linear-gradient(45deg, #ec4899, #06b6d4, #ec4899); }
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); }
        .animate-pulse-slow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        body { background: #0a0a0a; color: #fff; font-family: 'Segoe UI', sans-serif; }
    </style>
</head>
<body>
    <div id="login-section" class="min-h-screen bg-gradient-to-br from-black via-gray-900 to-black flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="glass-card rounded-3xl p-6 sm:p-8 border border-white/10">
                <div class="text-center mb-8">
                    <img src="logo.png" class="h-16 w-16 sm:h-20 sm:w-20 mx-auto mb-4 rounded-full border-2 border-cyan-400 object-cover">
                    <h1 class="text-3xl sm:text-4xl font-black italic mb-2 uppercase tok-gradient text-transparent bg-clip-text">TokSync</h1>
                    <p class="text-sm text-gray-400">üõ°Ô∏è Admin Control Panel</p>
                </div>

                <form id="admin-login-form" onsubmit="handleAdminLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs sm:text-sm font-bold text-gray-400 mb-2 uppercase">Admin Email</label>
                        <input type="email" id="admin-email" placeholder="admin@toksync.com" required
                            class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-2 sm:py-3 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-cyan-400 transition-colors">
                    </div>

                    <div>
                        <label class="block text-xs sm:text-sm font-bold text-gray-400 mb-2 uppercase">Admin Password</label>
                        <input type="password" id="admin-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required
                            class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-2 sm:py-3 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-cyan-400 transition-colors">
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-cyan-500 hover:from-pink-600 hover:to-cyan-600 text-white font-bold py-2 sm:py-3 rounded-xl transition-all uppercase text-sm tracking-tight mt-6">
                        üîì Login Admin
                    </button>
                </form>

                <p id="login-error" class="text-red-400 text-xs mt-4 text-center"></p>

                <div class="mt-6 p-3 sm:p-4 bg-cyan-500/10 border border-cyan-500/30 rounded-lg">
                    <p class="text-xs text-cyan-300"><strong>‚úÖ Admin Email:</strong></p>
                    <p class="text-xs text-gray-400 mt-1">admin@toksync.com</p>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden min-h-screen bg-gradient-to-br from-black via-gray-900 to-black">
        <!-- Admin Nav -->
        <nav class="sticky top-0 z-50 bg-black/90 border-b border-white/10 p-3 sm:p-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <img src="logo.png" class="h-7 w-7 sm:h-8 sm:w-8 rounded-full border border-cyan-400 object-cover">
                    <span class="font-black text-xs sm:text-sm tracking-tighter tok-gradient text-transparent bg-clip-text">TOKSYNC ADMIN</span>
                </div>
                <button onclick="logoutAdmin()" class="px-3 sm:px-4 py-1 sm:py-2 text-xs sm:text-sm bg-red-500/20 hover:bg-red-500/30 border border-red-500/40 rounded-lg transition-colors">
                    üö™ Logout
                </button>
            </div>
        </nav>

        <!-- Tab Navigation -->
        <div class="max-w-7xl mx-auto p-4 sm:p-6">
            <div class="flex flex-wrap gap-2 mb-6">
                <button onclick="showTab('users')" class="px-4 py-2 text-sm font-bold rounded-lg bg-cyan-500/20 border border-cyan-500/40 hover:bg-cyan-500/30 transition-colors">
                    üë• Users
                </button>
                <button onclick="showTab('send-notification')" class="px-4 py-2 text-sm font-bold rounded-lg bg-pink-500/20 border border-pink-500/40 hover:bg-pink-500/30 transition-colors">
                    üîî Send Notification
                </button>
                <button onclick="showTab('stats')" class="px-4 py-2 text-sm font-bold rounded-lg bg-purple-500/20 border border-purple-500/40 hover:bg-purple-500/30 transition-colors">
                    üìä Stats
                </button>
            </div>

            <!-- Users Tab -->
            <div id="tab-users" class="block">
                <div class="glass-card rounded-2xl p-5 sm:p-6 border border-white/10 mb-6">
                    <h2 class="text-xl sm:text-2xl font-black mb-4 uppercase tracking-tight">üë• User Management</h2>
                    
                    <div class="flex flex-col sm:flex-row gap-3 mb-6">
                        <input type="text" id="search-users" placeholder="Search by handle or email..." 
                            class="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-cyan-400">
                        <button onclick="loadAllUsers()" class="px-4 py-2 text-sm font-bold bg-cyan-500/20 border border-cyan-500/40 hover:bg-cyan-500/30 rounded-lg transition-colors">
                            üîÑ Refresh
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-xs sm:text-sm">
                            <thead class="border-b border-white/10">
                                <tr class="text-left">
                                    <th class="pb-2 px-2 font-bold text-cyan-400">Handle</th>
                                    <th class="pb-2 px-2 font-bold text-cyan-400">Email</th>
                                    <th class="pb-2 px-2 font-bold text-cyan-400">Name</th>
                                    <th class="pb-2 px-2 font-bold text-cyan-400">Points</th>
                                    <th class="pb-2 px-2 font-bold text-cyan-400">Status</th>
                                    <th class="pb-2 px-2 font-bold text-cyan-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="divide-y divide-white/10">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>

                    <p id="users-loading" class="text-gray-400 text-center py-8">Loading users...</p>
                </div>
            </div>

            <!-- Send Notification Tab -->
            <div id="tab-send-notification" class="hidden">
                <div class="glass-card rounded-2xl p-5 sm:p-6 border border-white/10 mb-6">
                    <h2 class="text-xl sm:text-2xl font-black mb-4 uppercase tracking-tight">üîî Send Notification</h2>
                    
                    <form onsubmit="handleSendNotification(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs sm:text-sm font-bold text-gray-400 mb-2">Recipient Type</label>
                            <select id="recipient-type" onchange="updateRecipientUI()" class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-sm text-white focus:outline-none focus:border-cyan-400">
                                <option value="all">üì¢ All Users</option>
                                <option value="single">üë§ Single User</option>
                            </select>
                        </div>

                        <div id="single-user-select" class="hidden">
                            <label class="block text-xs sm:text-sm font-bold text-gray-400 mb-2">Select User</label>
                            <input type="text" id="single-user-search" placeholder="Search user handle..." 
                                class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-cyan-400 mb-2">
                            <div id="user-suggestions" class="max-h-40 overflow-y-auto bg-white/5 rounded-lg border border-white/10 hidden"></div>
                            <input type="hidden" id="selected-user-id">
                        </div>

                        <div>
                            <label class="block text-xs sm:text-sm font-bold text-gray-400 mb-2">Title</label>
                            <input type="text" id="notification-title" placeholder="üî• NEW LINK DROP!" required
                                class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-cyan-400">
                        </div>

                        <div>
                            <label class="block text-xs sm:text-sm font-bold text-gray-400 mb-2">Message</label>
                            <textarea id="notification-message" placeholder="@alex_moves just dropped a link. Engage now for 5 points!" rows="4" required
                                class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-cyan-400 resize-none"></textarea>
                        </div>

                        <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-cyan-500 hover:from-pink-600 hover:to-cyan-600 text-white font-bold py-3 rounded-xl transition-all uppercase text-sm tracking-tight">
                            üì§ Send Notification
                        </button>
                    </form>

                    <p id="notification-status" class="text-center mt-4"></p>
                </div>
            </div>

            <!-- Stats Tab -->
            <div id="tab-stats" class="hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-2xl p-4 border border-white/10">
                        <p class="text-gray-400 text-xs uppercase mb-2">Total Users</p>
                        <p id="stat-total-users" class="text-3xl font-black text-cyan-400">0</p>
                    </div>
                    <div class="glass-card rounded-2xl p-4 border border-white/10">
                        <p class="text-gray-400 text-xs uppercase mb-2">Active Users</p>
                        <p id="stat-active-users" class="text-3xl font-black text-pink-400">0</p>
                    </div>
                    <div class="glass-card rounded-2xl p-4 border border-white/10">
                        <p class="text-gray-400 text-xs uppercase mb-2">Banned Users</p>
                        <p id="stat-banned-users" class="text-3xl font-black text-red-400">0</p>
                    </div>
                    <div class="glass-card rounded-2xl p-4 border border-white/10">
                        <p class="text-gray-400 text-xs uppercase mb-2">Total Points</p>
                        <p id="stat-total-points" class="text-3xl font-black text-purple-400">0</p>
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-5 sm:p-6 border border-white/10">
                    <h3 class="text-lg font-bold mb-4">Top 10 Users</h3>
                    <div id="top-users-list" class="space-y-2">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db, rtdb, messaging } from './firebase-config.js';
        import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { collection, getDocs, doc, updateDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import { ref, get, update } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        import { getToken } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging.js';

        let allUsers = [];
        let adminAuthenticatedUser = null;

        // Admin Login Handler
        window.handleAdminLogin = async (event) => {
            event.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('login-error');

            try {
                // Only admin@toksync.com can access admin panel
                if (email !== 'admin@toksync.com') {
                    errorEl.textContent = '‚ùå Only admin@toksync.com can access this panel';
                    return;
                }

                // Authenticate with Firebase
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                adminAuthenticatedUser = { uid: userCredential.user.uid, email, isAdmin: true };
                localStorage.setItem('adminSession', JSON.stringify(adminAuthenticatedUser));
                errorEl.textContent = '';
                showAdminDashboard();
                loadAllUsers();
            } catch (error) {
                errorEl.textContent = `‚ùå ${error.message}`;
            }
        };

        // Load all users
        window.loadAllUsers = async () => {
            try {
                const usersRef = ref(rtdb, 'users');
                const snapshot = await get(usersRef);
                
                allUsers = [];
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    for (const [userId, userData] of Object.entries(users)) {
                        allUsers.push({ uid: userId, ...userData });
                    }
                }

                displayUsers(allUsers);
                updateStats();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        };

        // Display users in table
        function displayUsers(usersToDisplay) {
            const tbody = document.getElementById('users-table-body');
            const loading = document.getElementById('users-loading');
            
            tbody.innerHTML = '';
            loading.classList.add('hidden');

            if (usersToDisplay.length === 0) {
                loading.classList.remove('hidden');
                loading.textContent = 'No users found';
                return;
            }

            usersToDisplay.forEach(user => {
                const isBanned = user.banned || false;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-2 font-bold text-cyan-400">@${user.handle || 'N/A'}</td>
                    <td class="py-3 px-2 text-gray-300">${user.email || 'N/A'}</td>
                    <td class="py-3 px-2 text-gray-300">${user.name || 'N/A'}</td>
                    <td class="py-3 px-2 font-bold text-pink-400">${user.points || 0}</td>
                    <td class="py-3 px-2">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${isBanned ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'}">
                            ${isBanned ? 'üö´ Banned' : '‚úÖ Active'}
                        </span>
                    </td>
                    <td class="py-3 px-2 space-x-1">
                        ${isBanned ? 
                            `<button onclick="unbanUser('${user.uid}')" class="px-2 py-1 text-xs bg-green-500/20 border border-green-500/40 rounded hover:bg-green-500/30 transition-colors">Unban</button>` :
                            `<button onclick="banUser('${user.uid}')" class="px-2 py-1 text-xs bg-red-500/20 border border-red-500/40 rounded hover:bg-red-500/30 transition-colors">Ban</button>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Ban user
        window.banUser = async (userId) => {
            if (!confirm('Are you sure you want to ban this user?')) return;
            try {
                const userRef = ref(rtdb, `users/${userId}`);
                await update(userRef, { banned: true });
                loadAllUsers();
            } catch (error) {
                alert('Error banning user: ' + error.message);
            }
        };

        // Unban user
        window.unbanUser = async (userId) => {
            if (!confirm('Unban this user?')) return;
            try {
                const userRef = ref(rtdb, `users/${userId}`);
                await update(userRef, { banned: false });
                loadAllUsers();
            } catch (error) {
                alert('Error unbanning user: ' + error.message);
            }
        };

        // Search users
        document.getElementById('search-users')?.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allUsers.filter(u => 
                (u.handle && u.handle.toLowerCase().includes(query)) ||
                (u.email && u.email.toLowerCase().includes(query))
            );
            displayUsers(filtered);
        });

        // Update recipient UI
        window.updateRecipientUI = () => {
            const type = document.getElementById('recipient-type').value;
            const singleUserSelect = document.getElementById('single-user-select');
            if (type === 'single') {
                singleUserSelect.classList.remove('hidden');
                setupUserSearch();
            } else {
                singleUserSelect.classList.add('hidden');
            }
        };

        // Setup user search for single notification
        function setupUserSearch() {
            const input = document.getElementById('single-user-search');
            const suggestions = document.getElementById('user-suggestions');

            input.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (query.length < 1) {
                    suggestions.classList.add('hidden');
                    return;
                }

                const filtered = allUsers.filter(u => 
                    u.handle && u.handle.toLowerCase().includes(query)
                );

                suggestions.innerHTML = filtered.map(u => `
                    <div onclick="selectUser('${u.uid}', '${u.handle}')" class="p-2 border-b border-white/10 cursor-pointer hover:bg-white/10 transition-colors">
                        @${u.handle} - ${u.email}
                    </div>
                `).join('');

                if (filtered.length > 0) {
                    suggestions.classList.remove('hidden');
                } else {
                    suggestions.classList.add('hidden');
                }
            });
        }

        // Select single user
        window.selectUser = (uid, handle) => {
            document.getElementById('selected-user-id').value = uid;
            document.getElementById('single-user-search').value = `@${handle}`;
            document.getElementById('user-suggestions').classList.add('hidden');
        };

        // Send notification
        window.handleSendNotification = async (event) => {
            event.preventDefault();
            
            const recipientType = document.getElementById('recipient-type').value;
            const title = document.getElementById('notification-title').value;
            const message = document.getElementById('notification-message').value;
            const statusEl = document.getElementById('notification-status');

            try {
                statusEl.textContent = '‚è≥ Sending...';
                statusEl.className = 'text-center mt-4 text-yellow-400';

                const payload = { notification: { title, body: message } };

                if (recipientType === 'all') {
                    // Send to all users with tokens
                    const tokensRef = collection(db, 'notification_tokens');
                    const tokens = await getDocs(tokensRef);
                    let sent = 0;

                    for (const doc of tokens.docs) {
                        try {
                            // In production, call your backend to send via Firebase Admin SDK
                            console.log('Would send to:', doc.data().token);
                            sent++;
                        } catch (err) {
                            console.error('Failed to send to token:', err);
                        }
                    }

                    statusEl.textContent = `‚úÖ Notification queued for ${sent} users! Send from Firebase Console for delivery.`;
                    statusEl.className = 'text-center mt-4 text-green-400';
                } else {
                    const userId = document.getElementById('selected-user-id').value;
                    if (!userId) {
                        statusEl.textContent = '‚ùå Please select a user';
                        statusEl.className = 'text-center mt-4 text-red-400';
                        return;
                    }

                    statusEl.textContent = `‚úÖ Notification prepared for user! Send from Firebase Console.`;
                    statusEl.className = 'text-center mt-4 text-green-400';
                }

                // Clear form
                event.target.reset();
                document.getElementById('selected-user-id').value = '';

            } catch (error) {
                statusEl.textContent = `‚ùå ${error.message}`;
                statusEl.className = 'text-center mt-4 text-red-400';
            }
        };

        // Update stats
        async function updateStats() {
            const totalUsers = allUsers.length;
            const activeUsers = allUsers.filter(u => !u.banned).length;
            const bannedUsers = allUsers.filter(u => u.banned).length;
            const totalPoints = allUsers.reduce((sum, u) => sum + (u.points || 0), 0);

            document.getElementById('stat-total-users').textContent = totalUsers;
            document.getElementById('stat-active-users').textContent = activeUsers;
            document.getElementById('stat-banned-users').textContent = bannedUsers;
            document.getElementById('stat-total-points').textContent = totalPoints;

            // Top 10 users
            const topUsers = [...allUsers]
                .sort((a, b) => (b.points || 0) - (a.points || 0))
                .slice(0, 10);

            const topList = document.getElementById('top-users-list');
            topList.innerHTML = topUsers.map((u, i) => `
                <div class="flex justify-between items-center p-3 bg-white/5 rounded-lg border border-white/10">
                    <div>
                        <p class="font-bold text-cyan-400">#${i + 1} @${u.handle}</p>
                        <p class="text-xs text-gray-400">${u.email}</p>
                    </div>
                    <p class="text-lg font-bold text-pink-400">${u.points || 0} pts</p>
                </div>
            `).join('');
        }

        // Show tab
        window.showTab = (tabName) => {
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            if (tabName === 'stats') {
                updateStats();
            }
        };

        // Show/hide sections
        function showAdminDashboard() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
        }

        // Logout
        window.logoutAdmin = () => {
            localStorage.removeItem('adminSession');
            adminAuthenticatedUser = null;
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('admin-email').value = '';
            document.getElementById('admin-password').value = '';
        };

        // Check if already logged in
        window.addEventListener('load', () => {
            const session = localStorage.getItem('adminSession');
            if (session) {
                adminAuthenticatedUser = JSON.parse(session);
                showAdminDashboard();
                loadAllUsers();
            }
        });
    </script>
</body>
</html>
